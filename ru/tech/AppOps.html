<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Операции приложения | Документация App Manager</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="A full-featured package manager and viewer for Android">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/AppManager/assets/css/0.styles.03a77600.css" as="style"><link rel="preload" href="/AppManager/assets/js/app.5333276d.js" as="script"><link rel="preload" href="/AppManager/assets/js/2.b7ff2a34.js" as="script"><link rel="preload" href="/AppManager/assets/js/58.59c42e69.js" as="script"><link rel="prefetch" href="/AppManager/assets/js/10.d8e7f70f.js"><link rel="prefetch" href="/AppManager/assets/js/11.00fd8fa4.js"><link rel="prefetch" href="/AppManager/assets/js/12.6bb1b872.js"><link rel="prefetch" href="/AppManager/assets/js/13.e5167225.js"><link rel="prefetch" href="/AppManager/assets/js/14.f3a7ace7.js"><link rel="prefetch" href="/AppManager/assets/js/15.9ea5d27a.js"><link rel="prefetch" href="/AppManager/assets/js/16.6260068c.js"><link rel="prefetch" href="/AppManager/assets/js/17.ceb10401.js"><link rel="prefetch" href="/AppManager/assets/js/18.55b96b2d.js"><link rel="prefetch" href="/AppManager/assets/js/19.375eee66.js"><link rel="prefetch" href="/AppManager/assets/js/20.8ce11435.js"><link rel="prefetch" href="/AppManager/assets/js/21.7ee9b266.js"><link rel="prefetch" href="/AppManager/assets/js/22.f8fd7410.js"><link rel="prefetch" href="/AppManager/assets/js/23.d9953555.js"><link rel="prefetch" href="/AppManager/assets/js/24.da842f5f.js"><link rel="prefetch" href="/AppManager/assets/js/25.a801c44e.js"><link rel="prefetch" href="/AppManager/assets/js/26.68de90c2.js"><link rel="prefetch" href="/AppManager/assets/js/27.ee17ae71.js"><link rel="prefetch" href="/AppManager/assets/js/28.ed9bcb77.js"><link rel="prefetch" href="/AppManager/assets/js/29.f491c9b5.js"><link rel="prefetch" href="/AppManager/assets/js/3.d34c2821.js"><link rel="prefetch" href="/AppManager/assets/js/30.61b067e4.js"><link rel="prefetch" href="/AppManager/assets/js/31.9c6f4526.js"><link rel="prefetch" href="/AppManager/assets/js/32.b2c4b41d.js"><link rel="prefetch" href="/AppManager/assets/js/33.049ace3d.js"><link rel="prefetch" href="/AppManager/assets/js/34.5de71fb4.js"><link rel="prefetch" href="/AppManager/assets/js/35.6a948eab.js"><link rel="prefetch" href="/AppManager/assets/js/36.c15fe39b.js"><link rel="prefetch" href="/AppManager/assets/js/37.6f2380c5.js"><link rel="prefetch" href="/AppManager/assets/js/38.8e010f0c.js"><link rel="prefetch" href="/AppManager/assets/js/39.d67a1862.js"><link rel="prefetch" href="/AppManager/assets/js/4.fd7ebf95.js"><link rel="prefetch" href="/AppManager/assets/js/40.0bd893b3.js"><link rel="prefetch" href="/AppManager/assets/js/41.a4a19a19.js"><link rel="prefetch" href="/AppManager/assets/js/42.96602cb3.js"><link rel="prefetch" href="/AppManager/assets/js/43.f0ebc363.js"><link rel="prefetch" href="/AppManager/assets/js/44.1efc9551.js"><link rel="prefetch" href="/AppManager/assets/js/45.3a5f4e7d.js"><link rel="prefetch" href="/AppManager/assets/js/46.c4beb2eb.js"><link rel="prefetch" href="/AppManager/assets/js/47.f0a1768e.js"><link rel="prefetch" href="/AppManager/assets/js/48.fa5c0b3e.js"><link rel="prefetch" href="/AppManager/assets/js/49.c3295dbb.js"><link rel="prefetch" href="/AppManager/assets/js/5.ab9db4f1.js"><link rel="prefetch" href="/AppManager/assets/js/50.0b3309b9.js"><link rel="prefetch" href="/AppManager/assets/js/51.a100a877.js"><link rel="prefetch" href="/AppManager/assets/js/52.fc5c8c61.js"><link rel="prefetch" href="/AppManager/assets/js/53.2fdb2635.js"><link rel="prefetch" href="/AppManager/assets/js/54.8c04dcaa.js"><link rel="prefetch" href="/AppManager/assets/js/55.597a7772.js"><link rel="prefetch" href="/AppManager/assets/js/56.dab61140.js"><link rel="prefetch" href="/AppManager/assets/js/57.e53527e6.js"><link rel="prefetch" href="/AppManager/assets/js/59.2f5e59b4.js"><link rel="prefetch" href="/AppManager/assets/js/6.2ab55e1c.js"><link rel="prefetch" href="/AppManager/assets/js/60.578a48a0.js"><link rel="prefetch" href="/AppManager/assets/js/61.00153ad9.js"><link rel="prefetch" href="/AppManager/assets/js/62.9288f8f7.js"><link rel="prefetch" href="/AppManager/assets/js/63.1db8b737.js"><link rel="prefetch" href="/AppManager/assets/js/64.97a3552a.js"><link rel="prefetch" href="/AppManager/assets/js/65.21ad16f1.js"><link rel="prefetch" href="/AppManager/assets/js/66.28fd43ba.js"><link rel="prefetch" href="/AppManager/assets/js/67.78e0e128.js"><link rel="prefetch" href="/AppManager/assets/js/68.32ff3201.js"><link rel="prefetch" href="/AppManager/assets/js/69.cd773c1f.js"><link rel="prefetch" href="/AppManager/assets/js/7.23213d96.js"><link rel="prefetch" href="/AppManager/assets/js/70.5ab85907.js"><link rel="prefetch" href="/AppManager/assets/js/71.52d05d66.js"><link rel="prefetch" href="/AppManager/assets/js/72.787639a4.js"><link rel="prefetch" href="/AppManager/assets/js/73.0b7c08a5.js"><link rel="prefetch" href="/AppManager/assets/js/74.c9fe519e.js"><link rel="prefetch" href="/AppManager/assets/js/75.7650fcc6.js"><link rel="prefetch" href="/AppManager/assets/js/76.05aaa81c.js"><link rel="prefetch" href="/AppManager/assets/js/77.490120ab.js"><link rel="prefetch" href="/AppManager/assets/js/78.1a52ae56.js"><link rel="prefetch" href="/AppManager/assets/js/79.711c77e2.js"><link rel="prefetch" href="/AppManager/assets/js/8.0f5d6b6d.js"><link rel="prefetch" href="/AppManager/assets/js/80.e1c15b40.js"><link rel="prefetch" href="/AppManager/assets/js/9.12e097cf.js">
    <link rel="stylesheet" href="/AppManager/assets/css/0.styles.03a77600.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AppManager/ru/" class="home-link router-link-active"><img src="/AppManager/icon.png" alt="Документация App Manager" class="logo"> <span class="site-name can-hide">Документация App Manager</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/AppManager/ru/guide/" class="nav-link">
  Инструкции
</a></div><div class="nav-item"><a href="/AppManager/ru/changelog.html" class="nav-link">
  Список изменений
</a></div><div class="nav-item"><a href="https://f-droid.org/packages/io.github.muntashirakon.AppManager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  F-Droid
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MuntashirAkon/AppManager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Исходный код
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Языки" class="dropdown-title"><span class="title">Языки</span> <span class="arrow down"></span></button> <button type="button" aria-label="Языки" class="mobile-dropdown-title"><span class="title">Языки</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppManager/tech/AppOps.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/pt-BR/tech/AppOps.html" class="nav-link">
  Português (Brasil)
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/ru/tech/AppOps.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Русский
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/zh-CN/tech/AppOps.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/AppManager/ru/guide/" class="nav-link">
  Инструкции
</a></div><div class="nav-item"><a href="/AppManager/ru/changelog.html" class="nav-link">
  Список изменений
</a></div><div class="nav-item"><a href="https://f-droid.org/packages/io.github.muntashirakon.AppManager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  F-Droid
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MuntashirAkon/AppManager" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Исходный код
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Языки" class="dropdown-title"><span class="title">Языки</span> <span class="arrow down"></span></button> <button type="button" aria-label="Языки" class="mobile-dropdown-title"><span class="title">Языки</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/AppManager/tech/AppOps.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/pt-BR/tech/AppOps.html" class="nav-link">
  Português (Brasil)
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/ru/tech/AppOps.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Русский
</a></li><li class="dropdown-item"><!----> <a href="/AppManager/zh-CN/tech/AppOps.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Инструкции</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AppManager/ru/guide/" class="sidebar-link">Введение</a></li><li><a href="/AppManager/ru/guide/adb-over-tcp.html" class="sidebar-link">ADB через TCP</a></li><li><a href="/AppManager/ru/guide/main-page.html" class="sidebar-link">Главная страница</a></li><li><a href="/AppManager/ru/guide/app-details-page.html" class="sidebar-link">Страница «Сведения о приложении»</a></li><li><a href="/AppManager/ru/guide/one-click-ops-page.html" class="sidebar-link">Страница «Операции в один клик»</a></li><li><a href="/AppManager/ru/guide/exodus-page.html" class="sidebar-link">Страница εxodus</a></li><li><a href="/AppManager/ru/guide/shared-pref-editor-page.html" class="sidebar-link">Страница «Редактор общих настроек»</a></li><li><a href="/AppManager/ru/guide/settings-page.html" class="sidebar-link">Страница «Настройки»</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/AppManager/ru/faq" class="sidebar-heading clickable"><span>Часто задаваемые вопросы</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/AppManager/ru/faq/app-components.html" class="sidebar-link">Компоненты приложения</a></li><li><a href="/AppManager/ru/faq/adb.html" class="sidebar-link">ADB через TCP</a></li><li><a href="/AppManager/ru/faq/misc.html" class="sidebar-link">Разное</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/AppManager/ru/tech" class="sidebar-heading clickable router-link-active open"><span>Техническая информация</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/AppManager/ru/tech/AppOps.html" aria-current="page" class="active sidebar-link">Операции приложения</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#фоновыи-режим" class="sidebar-link">Фоновый режим</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#знакомство-с-операциями-приложении" class="sidebar-link">Знакомство с операциями приложений</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#appopsmanager" class="sidebar-link">AppOpsManager</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#константы-op" class="sidebar-link">Константы OP_*</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#константы-mode" class="sidebar-link">Константы MODE_*</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#операции-пакетов" class="sidebar-link">Операции пакетов</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#opentry" class="sidebar-link">OpEntry</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#использование" class="sidebar-link">Использование</a></li></ul></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#служба-appopsservice" class="sidebar-link">Служба AppOpsService</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#appops-xml" class="sidebar-link">appops.xml</a></li><li class="sidebar-sub-header"><a href="/AppManager/ru/tech/AppOps.html#интерфеис-команднои-строки-appops" class="sidebar-link">Интерфейс командной строки appops</a></li></ul></li><li><a href="/AppManager/ru/tech/rules-specification.html" class="sidebar-link">App Manager: спецификация правил</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="операции-приложения"><a href="#операции-приложения" class="header-anchor">#</a> Операции приложения</h1> <p><em>Перейдите к <a href="https://github.com/MuntashirAkon/AppManager/issues/17" target="_blank" rel="noopener noreferrer">похожей проблеме<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> для обсуждения.</em></p> <details class="custom-block details"><summary>Таблица содержания</summary> <p></p><div class="table-of-contents"><ul><li><a href="#фоновыи-режим">Фоновый режим</a></li><li><a href="#знакомство-с-операциями-приложении">Знакомство с операциями приложений</a></li><li><a href="#appopsmanager">AppOpsManager</a><ul><li><a href="#константы-op">Константы OP_*</a></li><li><a href="#константы-mode">Константы MODE_*</a></li><li><a href="#операции-пакетов">Операции пакетов</a></li><li><a href="#opentry">OpEntry</a></li><li><a href="#использование">Использование</a></li></ul></li><li><a href="#служба-appopsservice">Служба AppOpsService</a></li><li><a href="#appops-xml">appops.xml</a></li><li><a href="#интерфеис-команднои-строки-appops">Интерфейс командной строки appops</a></li></ul></div><p></p></details> <h2 id="фоновыи-режим"><a href="#фоновыи-режим" class="header-anchor">#</a> Фоновый режим</h2> <p><strong>Операции приложения</strong> используются системой Android (начиная с Android 4.3) для управления разрешениями приложений. Пользователь <em>может</em> контролировать некоторые разрешения, но только те разрешения, которые считаются опасными (однако Google считает, что знание вашего номера телефона не опасно). Итак, кажется, что операции приложений – это то, что нам нужно, если мы хотим устанавливать такие приложения, как Facebook, Facebook Messenger (который буквально записывает все), и все еще хотим <em>немного</em> приватности и/или безопасности. Хотя некоторые функции приложений были доступны в настройках, а затем в скрытых настройках в более старых версиях Android, в новых версиях Android они полностью скрыты и продолжают оставаться скрытыми. Теперь любое приложение с разрешением <strong>android.Manifest.permission.GET_APP_OPS_STATS</strong> может получать информацию об операциях приложения для других приложений, но это разрешение скрыто от пользователей и может быть включено только с помощью ADB или root. Тем не менее, приложение с этим разрешением не может предоставлять или отзывать разрешения (фактически режим операции) для приложений, отличных от себя (конечно, с ограниченными возможностями). Для изменения операции другого приложения, приложению необходимо разрешение <strong>android.Manifest.permission.UPDATE_APP_OPS_STATS</strong>, которое недоступно через команду <em>pm</em>. Таким образом, вы не можете предоставить его через root или ADB, разрешение предоставляется только системным приложениям. Очень мало приложений, которые поддерживают отключение разрешений через операции приложения. Насколько мне известно, лучшее среди них это <a href="https://github.com/8enet/AppOpsX" target="_blank" rel="noopener noreferrer">AppOpsX<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Основное (видимое) различие между моим приложением (App Manager) и этим приложением заключается в том, что последнее также предоставляет вам возможность отменять разрешения в интернете (путем написания таблиц IP). Другое отличие состоит в том, что автор использовал скрытый API для доступа/предоставления/отзыва операций, тогда как я использовал инструмент командой строки <a href="#%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%BD%D0%BE%D0%B9-%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B8-appops"><em>appops</em></a> для этого. Я сделал это из-за предела <a href="https://stackoverflow.com/questions/37628" target="_blank" rel="noopener noreferrer">рефлексии<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&lt; недавно введенной в Android, которая сделала многие скрытые API непригодными для использования (есть некоторые хаки, но они могут не работать после выхода финальной версии Android R). Одна из важнейших проблем, с которыми я столкнулся при разработке API раздела операций приложений, – это отсутствие документации на английском языке.</p> <h2 id="знакомство-с-операциями-приложении"><a href="#знакомство-с-операциями-приложении" class="header-anchor">#</a> Знакомство с операциями приложений</h2> <img src="/AppManager/assets/how_app_ops_work.png" alt="Как работают операции приложений"> <p>Фигура (взята из <a href="https://translate.googleusercontent.com/translate_c?depth=2&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=auto&amp;sp=nmt4&amp;tl=en&amp;u=https://www.cnblogs.com/0616--ataozhijia/p/5009718.html&amp;usg=ALkJrhgSo4IcKp2cXJlqttXuiRJZGa_jnw" target="_blank" rel="noopener noreferrer">этой статьи<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) выше описывает процесс изменения и обработки разрешения. <a href="#AppOpsManager"><strong>AppOpsManager</strong></a> можно использовать для управления разрешениями в приложении &quot;Настройки&quot;. <strong>AppOpsManager</strong> также полезен при определении того, предоставлено ли приложению определенное разрешение (или операция). Большинство методов <strong>AppOpsManager</strong> доступны для пользовательских приложений, но в отличие от системных приложений, их можно использовать только для проверки разрешений для любого приложения или для самого приложения, а также для запуска или завершения определенных операций. Более того, не все операции фактически доступны из этого класса Java. <strong>Диспетчер операций приложений</strong> содержит все необходимые константы, такие как <a href="#%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B-op"><em>OP_*</em></a>, <code>OPSTR_*</code>, <a href="#%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B-mode"><em>MODE_*</em></a>, которые описывают код операции, строку операции и режим работы соответственно. Он также содержит необходимые структуры данных, такие как <a href="#%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2"><strong>PackageOps</strong></a> и <strong>OpEntry</strong>. <strong>PackageOps</strong> держит <strong>OpEntry</strong> длч пакета, и <strong>OpEntry</strong>, как следует из названия, описывает каждую операцию. Под влиянием, <strong>AppOpsManager</strong> вызывает службу <strong>AppOpsService</strong> выполнять любую реальную работу.</p> <p>Служба <a href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/appop/AppOpsService.java" target="_blank" rel="noopener noreferrer"><strong>AppOpService</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> полностью скрыта для пользовательских приложений, но доступна для системных. Как видно на рисунке, это класс, который выполняет фактическое управление. Он содержит такие структуры данных, как <strong>операции</strong> для хранения базовой информации о пакете и <strong>операцию</strong> что похоже на <strong>OpEntry</strong> из <strong>AppOpsManager</strong>. Он также имеет <strong>оболочку</strong> которая на самом деле является исходным кодом инструмента командной строки_appops_. Он записывает или считывает конфигурации из <a href="#appops-xml">/data/system/appops.xml</a>. Системные службы вызывают <strong>AppOpsService</strong>, чтобы узнать, какие приложения разрешены, а какие не разрешены, а <strong>AppOpsService</strong> определяет эти разрешения путем анализа <code>/data/system/appops.xml</code>. Если пользовательские значения не заданы в <em>appops.xml</em>, он возвращает режим по умолчанию, доступный в <strong>AppOpsManager</strong>.</p> <h2 id="appopsmanager"><a href="#appopsmanager" class="header-anchor">#</a> AppOpsManager</h2> <p><a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/app/AppOpsManager.java" target="_blank" rel="noopener noreferrer">AppOpsManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, он же «Диспетчер операций приложений». Он содержит в себе различные константы и классы для редактирования операций приложений. Официальную документацию по нему можно найти <a href="https://developer.android.com/reference/android/app/AppOpsManager" target="_blank" rel="noopener noreferrer">здесь<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="константы-op"><a href="#константы-op" class="header-anchor">#</a> Константы OP_*</h3> <p><code>OP_*</code> – целые константы, начинающиеся с цифры <code>0</code>. Константа <code>OP_NONE</code> указывает, что операции не определены, тогда как <code>_NUM_OP</code> обозначает количество операций, определенных в префиксе <code>OP_*</code>.  Обозначает каждую операцию. Но эти операции не обязательно должны быть уникальными. Фактически, есть много операций, которые на самом деле являются одной операцией, обозначенной несколькими константами <code>OP_*</code> (возможно, для будущего использования). Надстройки Android могут определять операции в зависимости от своих требований. MIUI – одна из известных надстроек, которая умеет это делать.</p> <p><em>Краткий обзор <code>OP_*</code>:</em></p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_NONE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_COARSE_LOCATION <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_FINE_LOCATION <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_GPS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_VIBRATE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_READ_DEVICE_IDENTIFIERS <span class="token operator">=</span> <span class="token number">89</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_ACCESS_MEDIA_LOCATION <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_ACTIVATE_PLATFORM_VPN <span class="token operator">=</span> <span class="token number">91</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _NUM_OP <span class="token operator">=</span> <span class="token number">92</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Уникальность операции определяется переменной <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/app/AppOpsManager.java;drc=44cbdec292c6b234d94aae59257721cf499989ba;bpv=1;bpt=1;l=211?q=AppOpsManager&amp;ss=android%2Fplatform%2Fsuperproject&amp;gsn=sOpToSwitch&amp;gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Djava%3Fpath%3Dandroid.app.AppOpsManager%238ffb80c9b09fce58d7fe1a0af7d50fd025765d8f41e838fa3bc2754dd99d9c48" target="_blank" rel="noopener noreferrer"><code>sOpToSwitch</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Она соотносит каждую операцию с другой операцией или с самой собой (если это уникальная операция). Например, <code>OP_FINE_LOCATION</code> и <code>OP_GPS</code> сопоставлены с <code>OP_COARSE_LOCATION</code>.</p> <p>Каждая операция имеет личное имя, которое описывается переменной <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/app/AppOpsManager.java;drc=44cbdec292c6b234d94aae59257721cf499989ba;bpv=1;bpt=1;l=311?gsn=sOpNames&amp;gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Djava%3Fpath%3Dandroid.app.AppOpsManager%234f77b221ad3e5d9212e217eadec0b78cd35717a3bf2d0f2bc642dea241e02d72" target="_blank" rel="noopener noreferrer"><code>sOpNames</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Эти имена обычно совпадают с именами констант без префикса <code>OP_</code>. Некоторые операции также имеют публичные имена, которые описываются описываются переменной <code>sOpToString</code>. Например, <code>OP_COARSE_LOCATION</code> имеет публичное имя <strong>android:coarse_location</strong>.</p> <p>По мере постепенного процесса перемещения разрешений в операции приложений уже существует множество разрешений, определенных для некоторых операций. Эти разрешения сопоставляются со значением <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/app/AppOpsManager.java;drc=44cbdec292c6b234d94aae59257721cf499989ba;bpv=1;bpt=1;l=361?gsn=sOpPerms&amp;gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Djava%3Fpath%3Dandroid.app.AppOpsManager%23230bc1462b07a3c1575477761782a9d3537d75b4ea0a16748082c74f50bc2814" target="_blank" rel="noopener noreferrer"><code>sOpPerms</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Например, разрешение <strong>android.Manifest.permission.ACCESS_COARSE_LOCATION</strong> сопоставлено с <code>OP_COARSE_LOCATION</code>. Некоторые операции могут не иметь соответствующих разрешений, которые имеют значения <code>null</code>.</p> <p>Как описано в предыдущем разделе, операции, настроенные для приложения, хранятся в <a href="#appops-xml">/data/system/appops.xml</a>. Если операция не настроена, то будет ли система разрешать эту операцию, определяется из значения <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/app/AppOpsManager.java;drc=44cbdec292c6b234d94aae59257721cf499989ba;bpv=1;bpt=1;l=410?gsn=sOpDefaultMode&amp;gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Djava%3Fpath%3Dandroid.app.AppOpsManager%23a8c8e4e247453a8ce329b2c1130f9c7a7f91e2b97d159c3e18c768b4d42f1b75" target="_blank" rel="noopener noreferrer"><code>sOpDefaultMode</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. В нем отображается <em>режим по умолчанию</em> для каждой операции.</p> <h3 id="константы-mode"><a href="#константы-mode" class="header-anchor">#</a> Константы MODE_*</h3> <p>Константы <code>MODE_*</code>, а также целочисленные константы, начинаются с цифры <code>0</code>. Эти константы назначаются каждой операции, описывающей, авторизовано ли приложение для выполнения этой операции. Эти режимы обычно имеют связанные имена, такие как <strong>allow</strong> для <code>MODE_ALLOWED</code>, <strong>ignore</strong> для <code>MODE_IGNORED</code>, <strong>deny</strong> для <code>MODE_ERRORED</code> (довольно мизономер), <strong>default</strong> для <code>MODE_DEFAULT</code> и <strong>foreground</strong> для <code>MODE_FOREGROUND</code>.</p> <p><em>Стандартные режимы:</em></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * данному вызывающему абоненту разрешено выполнять данную операцию.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_ALLOWED <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * данному звонящему не разрешено выполнять данную операцию, и эта попытка должна
 * &lt;em&gt;молча потерпеть неудачу&lt;/em&gt; (это не должно привести к сбою приложения).
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_IGNORED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * данному звонящему не разрешено выполнять данную операцию, и эта попытка должна
 * вызвать фатальную ошибку, обычно это {@link SecurityException}.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_ERRORED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>
<span class="token comment">/**
 * данный звонящий должен использовать проверку безопасности по умолчанию. Этот режим обычно не используется
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_DEFAULT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Специальный режим, который означает «разрешить, только когда приложение используется».
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MODE_FOREGROUND <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Помимо этих режимов по умолчанию, поставщики могут устанавливать собственные режимы, такие как <code>MODE_ASK</code> (с именем <strong>ask</strong>), который активно используется в MIUI. MIUI также использует некоторые другие режимы без каких-либо связанных с ними имен.</p> <h3 id="операции-пакетов"><a href="#операции-пакетов" class="header-anchor">#</a> Операции пакетов</h3> <p><strong>AppOpsManager.PackageOps</strong> – это структура данных для хранения всех <strong>OpEntry</strong> пакета. Проще говоря, она хранит все настроенные операции для пакета.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PackageOps</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> mPackageName<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mUid<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpEntry</span><span class="token punctuation">&gt;</span></span> mEntries<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Как видно выше, в нем хранятся все <strong>OpEntry</strong> пакета, а также соответствующее имя пакета и его идентификатор пользователя ядра.</p> <h3 id="opentry"><a href="#opentry" class="header-anchor">#</a> OpEntry</h3> <p><strong>AppOpsManager.OpEntry</strong> – это структура данных, в которой хранится одна операция для любого пакета.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OpEntry</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mOp<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mRunning<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Mode</span> <span class="token keyword">int</span> mMode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LongSparseLongArray</span> mAccessTimes<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LongSparseLongArray</span> mRejectTimes<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LongSparseLongArray</span> mDurations<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LongSparseLongArray</span> mProxyUids<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LongSparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mProxyPackageNames<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Здесь:</p> <ul><li><code>mOp</code>: обозначает одну из констант <a href="#%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B-op"><code>OP_*</code></a>.</li> <li><code>mRunning</code>: выполняются ли операции (т. е, операция началась, но еще не завершена). Не все операции можно запустить или завершить таким образом.</li> <li><code>mMOde</code>: одна из констант <a href="#%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B-mode"><code>MODE_*</code></a>.</li> <li><code>mAccessTimes</code>: хранит все доступные времена принятия</li> <li><code>mRejectTimes</code>: хранит все доступные времена отклонения</li> <li><code>mDurations</code>: все доступные длительности доступа, выполняемые с помощью <code>mRunning</code> сообщат вам, как долго приложение выполняет определенную операцию.</li> <li><code>mProxyUids</code>: документация не найдена</li> <li><code>mProxyPackageNames</code>: документация не найдена</li></ul> <h3 id="использование"><a href="#использование" class="header-anchor">#</a> Использование</h3> <p>Список задач</p> <h2 id="служба-appopsservice"><a href="#служба-appopsservice" class="header-anchor">#</a> Служба AppOpsService</h2> <p>Список задач</p> <h2 id="appops-xml"><a href="#appops-xml" class="header-anchor">#</a> appops.xml</h2> <p><code>appops.xml</code> имеет следующий формат: (этот шаблон создан мной и никоим образом не претендует на звание идеального образца, может содержать проблемы с совместимостью).</p> <div class="language-dtd line-numbers-mode"><pre class="language-text"><code>&lt;!DOCTYPE app-ops [

&lt;!ELEMENT app-ops (uid|pkg)*&gt;
&lt;!ATTLIST app-ops v CDATA #IMPLIED&gt;

&lt;!ELEMENT uid (op)*&gt;
&lt;!ATTLIST uid n CDATA #REQUIRED&gt;

&lt;!ELEMENT pkg (uid)*&gt;
&lt;!ATTLIST pkg n CDATA #REQUIRED&gt;

&lt;!ELEMENT uid (op)*&gt;
&lt;!ATTLIST uid
n CDATA #REQUIRED
p CDATA #IMPLIED&gt;

&lt;!ELEMENT op (st)*&gt;
&lt;!ATTLIST op
n CDATA #REQUIRED
m CDATA #REQUIRED&gt;

&lt;!ELEMENT st EMPTY&gt;
&lt;!ATTLIST st
n CDATA #REQUIRED
t CDATA #IMPLIED
r CDATA #IMPLIED
d CDATA #IMPLIED
pp CDATA #IMPLIED
pu CDATA #IMPLIED&gt;

]&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>Приведенные ниже инструкции следуют точному порядку, указанному выше:</p> <ul><li><code>app-ops</code>: корневой элемент. Оно может содержать любое количество <code>pkg</code> или пакетов <code>uid</code> <ul><li><code>v</code>: (опционально, целое число) номер версии (по умолчанию: <code>NO_VERSION</code> или <code>-1</code>)</li></ul></li> <li><code>pkg</code>: информация о пакете магазинов. Оно может содержать любое количество <code>uid</code> <ul><li><code>n</code>: (обязательно, строка) название пакета</li></ul></li> <li>Пакет <code>uid</code>: хранит пакет или информацию о пакетах
<ul><li><code>n</code>: (обязательно, целое число) идентификатор пользователя</li></ul></li> <li><code>uid</code>: идентификатор пользователя пакета Оно может содержать любое количество <code>операций</code> <ul><li><code>n</code>: (обязательно, целое число) идентификатор пользователя</li> <li><code>p</code>: (необязательно, логический) указывает, является ли приложение приватным или системным</li></ul></li> <li><code>op</code>: операция, которая может содержать <code>st</code> или вообще ничего
<ul><li><code>n</code>: (обязательно, целое число) имя операции в целом числе AppOpsManager.OP_*</li> <li><code>m</code>: (обязательно, целое число) режим операции AppOpsManager.MODE_*</li></ul></li> <li><code>st</code>: состояние операции: выполняется ли операция, выполняется ли доступ, отклонено или запущено (недоступно в старых версиях)
<ul><li><code>n</code>: (обязательно, длинное число) ключ, содержащий флаги и uid</li> <li><code>t</code>: (опционально, длинное число) время доступа (по умолчанию: <code>0</code>)</li> <li><code>r</code>: (опционально, длинное число) время отклонения (по умолчанию: <code>0</code>)</li> <li><code>d</code>: (опционально, длинное число) длительность доступа (по умолчанию: <code>0</code>)</li> <li><code>pp</code>: (опционально, строка) имя пакета прокси</li> <li><code>pu</code>: (опционально, целое число) uid пакета прокси</li></ul></li></ul> <p>Это определение можно найти на странице <a href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/appop/AppOpsService.java" target="_blank" rel="noopener noreferrer"><strong>AppOpsService</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="интерфеис-команднои-строки-appops"><a href="#интерфеис-команднои-строки-appops" class="header-anchor">#</a> Интерфейс командной строки appops</h2> <p><code>appops</code> или <code>cmd appops</code> (в последних версиях) могут быть доступны через ADB или root. Это более простой способ получить или обновить любую операцию для пакета (при условии, что имя пакета известно). Страница справки по этой команде не требует пояснений:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Команды службы AppOps (appops):
help
  Напишите этот текст для получения справки.
start [--user &lt;USER_ID&gt;] &lt;PACKAGE | UID&gt; &lt;OP&gt; 
  Запускает заданную операцию для определенного приложения.
stop [--user &lt;USER_ID&gt;] &lt;PACKAGE | UID&gt; &lt;OP&gt; 
  Останавливает заданную операцию для определенного приложения.
set [--user &lt;USER_ID&gt;] &lt;[--uid] PACKAGE | UID&gt; &lt;OP&gt; &lt;MODE&gt;
  Устанавливает режим для конкретного приложения и операции.
get [--user &lt;USER_ID&gt;] &lt;PACKAGE | UID&gt; [&lt;OP&gt;]
  Возвращает режим для конкретного приложения и дополнительной операции.
query-op [--user &lt;USER_ID&gt;] &lt;OP&gt; [&lt;MODE&gt;]
  Вывод всех пакетов, которые в данный момент имеют данную операцию в данном режиме.
reset [--user &lt;USER_ID&gt;] [&lt;PACKAGE&gt;]
  Сброс данного приложение или все приложения в режимы по умолчанию.
write-settings
  Немедленная запись ожидающих изменений в хранилище.
read-settings
  Чтение последних записанных настроек, заменив текущее состояние в ОЗУ.
опции:
  &lt;PACKAGE&gt; имя пакета Android или его UID, если перед ним стоит префикс --uid
  &lt;OP&gt;      операция AppOps.
  &lt;MODE&gt;    одно из разрешить, игнорировать, запретить или по умолчанию
  &lt;USER_ID&gt; идентификатор пользователя, под которым установлен пакет. Если --user не указан
            , предполагается текущий пользователь.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">18.11.2020, 22:08:10</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/AppManager/ru/tech/" class="prev router-link-active">
        /ru/tech/
      </a></span> <span class="next"><a href="/AppManager/ru/tech/rules-specification.html">
        App Manager: спецификация правил
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/AppManager/assets/js/app.5333276d.js" defer></script><script src="/AppManager/assets/js/2.b7ff2a34.js" defer></script><script src="/AppManager/assets/js/58.59c42e69.js" defer></script>
  </body>
</html>
